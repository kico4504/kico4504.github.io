<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>çˆ¶è¦ªç¯€æ’ˆéŒ¢é«”æ„ŸéŠæˆ²</title>
<style>
    body {
        margin: 0;
        text-align: center;
        background: #87CEEB;
        font-family: Arial, sans-serif;
    }
    #gameCanvas {
        background: #cceeff;
        display: block;
        margin: 0 auto;
        border: 2px solid #333;
    }
    #score, #timer {
        font-size: 20px;
        margin: 10px;
    }
    #charSelect {
        margin-top: 50px;
    }
    .charBtn {
        font-size: 18px;
        padding: 10px 20px;
        margin: 10px;
        cursor: pointer;
        border-radius: 8px;
        border: none;
        background-color: #ffcc00;
    }
    #muteBtn {
        font-size: 20px;
        padding: 5px 10px;
        cursor: pointer;
        position: fixed;
        top: 10px;
        right: 10px;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet"></script>
</head>
<body>

<h1>çˆ¶è¦ªç¯€æ’ˆéŒ¢é«”æ„ŸéŠæˆ² ğŸ‰</h1>
<div id="score">é‡‘é¡ï¼š0 å…ƒ</div>
<div id="timer">æ™‚é–“ï¼š60</div>
<button id="muteBtn">ğŸ”Š</button>
<canvas id="gameCanvas" width="800" height="600"></canvas>

<div id="charSelect">
    <h2>é¸æ“‡ä½ çš„è§’è‰²</h2>
    <button class="charBtn" onclick="selectChar('çˆ¸çˆ¸')">çˆ¸çˆ¸</button>
    <button class="charBtn" onclick="selectChar('åª½åª½')">åª½åª½</button>
    <button class="charBtn" onclick="selectChar('å°å¥³å­©')">å°å¥³å­©</button>
</div>

<audio id="bgm" loop autoplay>
    <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_6b1706314f.mp3?filename=happy-advertising-11256.mp3" type="audio/mpeg">
</audio>

<script>
let canvas = document.getElementById("gameCanvas");
let ctx = canvas.getContext("2d");
let score = 0;
let timeLeft = 60;
let player = { x: 400, y: 500, size: 50, range: 50, char: "" };
let objects = [];
let gameRunning = false;
let video, net;

// æ‰è½ç‰©æ¸…å–®
const moneyItems = [
    { type: "coin1", value: 1, color: "#FFD700" },
    { type: "coin5", value: 5, color: "#DAA520" },
    { type: "coin10", value: 10, color: "#C0C0C0" },
    { type: "coin50", value: 50, color: "#B8860B" },
    { type: "bill100", value: 100, color: "#FF6666" }
];
const tools = [
    { type: "basket", range: 30, color: "#8B4513" },
    { type: "net", range: 50, color: "#228B22" },
    { type: "bag", range: 40, color: "#CD853F" },
    { type: "clock", extraTime: 60, color: "#87CEFA" }
];

function selectChar(name) {
    player.char = name;
    document.getElementById("charSelect").style.display = "none";
    startGame();
}

function startGame() {
    score = 0;
    timeLeft = 60;
    player.x = 400;
    player.range = 50;
    objects = [];
    gameRunning = true;
    setInterval(spawnObject, 800);
    setInterval(() => { if (timeLeft > 0) timeLeft--; }, 1000);
    requestAnimationFrame(gameLoop);
    initCamera();
}

function spawnObject() {
    if (!gameRunning) return;
    let rand = Math.random();
    if (rand < 0.7) {
        objects.push({
            ...moneyItems[Math.floor(Math.random() * moneyItems.length)],
            x: Math.random() * canvas.width,
            y: -20,
            speed: 3
        });
    } else {
        objects.push({
            ...tools[Math.floor(Math.random() * tools.length)],
            x: Math.random() * canvas.width,
            y: -20,
            speed: 2
        });
    }
}

function drawPlayer() {
    ctx.fillStyle = "#333";
    ctx.beginPath();
    ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = "#fff";
    ctx.font = "16px Arial";
    ctx.fillText(player.char, player.x - 20, player.y + 5);
}

function drawObjects() {
    for (let o of objects) {
        ctx.fillStyle = o.color;
        ctx.beginPath();
        ctx.arc(o.x, o.y, 15, 0, Math.PI * 2);
        ctx.fill();
    }
}

function updateObjects() {
    for (let o of objects) {
        o.y += o.speed;
        let dist = Math.hypot(o.x - player.x, o.y - player.y);
        if (dist < player.size + player.range) {
            if (o.value) score += o.value;
            if (o.range) player.range += o.range;
            if (o.extraTime) timeLeft += o.extraTime;
            objects = objects.filter(item => item !== o);
        }
    }
    objects = objects.filter(o => o.y < canvas.height + 20);
}

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (timeLeft <= 0) {
        gameRunning = false;
        ctx.fillStyle = "#000";
        ctx.font = "30px Arial";
        ctx.fillText("éŠæˆ²çµæŸï¼ç¸½é‡‘é¡ï¼š" + score + " å…ƒ", 200, 300);
        return;
    }
    updateObjects();
    drawObjects();
    drawPlayer();
    document.getElementById("score").textContent = "é‡‘é¡ï¼š" + score + " å…ƒ";
    document.getElementById("timer").textContent = "æ™‚é–“ï¼š" + timeLeft;
    requestAnimationFrame(gameLoop);
}

document.getElementById("muteBtn").onclick = function() {
    let bgm = document.getElementById("bgm");
    bgm.muted = !bgm.muted;
    this.textContent = bgm.muted ? "ğŸ”‡" : "ğŸ”Š";
};

// é«”æ„Ÿæ§åˆ¶ï¼šä½¿ç”¨ Posenet åµæ¸¬å·¦å³ç§»å‹•
async function initCamera() {
    video = document.createElement("video");
    video.width = 640;
    video.height = 480;
    video.autoplay = true;
    await navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
        video.srcObject = stream;
    });
    net = await posenet.load();
    detectPose();
}

async function detectPose() {
    if (!gameRunning) return;
    const pose = await net.estimateSinglePose(video, { flipHorizontal: true });
    let nose = pose.keypoints.find(k => k.part === "nose");
    if (nose && nose.score > 0.5) {
        player.x = canvas.width - (nose.position.x / video.width) * canvas.width;
    }
    requestAnimationFrame(detectPose);
}
</script>

</body>
</html>
